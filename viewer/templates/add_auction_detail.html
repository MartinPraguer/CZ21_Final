{% extends "base.html" %}
{% block content %}

<!-- Zobrazení obrázků pro danou aukci -->
{% if auction.images.all %}
    <h3>Images:</h3>
    <div>
        {% for image in auction.images.all %}
            <a href="{{ image.image.url }}" data-lightbox="auction-images"><img src="{{ image.image.url }}" alt="Image for {{ auction.name_auction }}" style="width: 300px; height: auto;"></a>
        {% endfor %}
    </div>
{% else %}
    <p>No images for this auction.</p>
{% endif %}
<h2>{{ auction.name_auction }}</h2>
<p>Category: {{ auction.category }}</p>
<p>Description: {{ auction.description }}</p>

<!-- Odkaz na detail uživatele, který vytvořil aukci -->
<p>Auction Creater: <a href="{% url 'user_detail' auction.user_creator.id %}">{{ auction.user_creator }}</a></p>

<p>Auction Starts: {{ auction.auction_start_date|date:"d.m.Y H:i:s" }}</p>
<p>Auction Ends: {{ auction.auction_end_date|date:"d.m.Y H:i:s" }}</p>
<p>Numbers of Views: {{ auction.number_of_views }}</p>
{% if auction_expired %}
    <p>Auction has expired</p>
{% else %}
    <p>Time Left: {{ days }} days, {{ hours }} hours, {{ minutes }} minutes</p>
{% endif %}

{% if auction.auction_type == 'buy_now' %}
    <p>Price: {{ auction.buy_now_price }} Kč</p>
    <h3>Buy Now</h3>

    {% if auction_expired %}
        <p style="color: red;">This auction has already expired. It cannot be bought.</p>
    {% else %}
        <form method="post" action="{% url 'add_to_cart' auction.pk %}">
            {% csrf_token %}
            <button type="submit">Add to Cart</button>
        </form>
    {% endif %}
{% endif %}

{% if auction.auction_type == 'place_bid' %}
    <p>Starting Price: {{ auction.start_price }} Kč</p>
    {% if auction.price %}
        <p>Price: <span id="current_price">{{ auction.price }}</span> Kč</p>
    {% endif %}
    <p>Minimum Bid: {{ auction.minimum_bid }} Kč</p>

    {% if auction_expired %}
        <p style="color: red;">The auction has already ended. It is not possible to add more bids.</p>
    {% else %}
        {% if error_message %}
    <p style="color: red;">{{ error_message }}</p>
        {% endif %}
        <form method="post">
            {% csrf_token %}
            <label for="new_bid">Your Bid:</label>
            <input type="number" id="new_bid" name="new_bid" min="1" required>
            <button type="submit">Place Bid</button>
        </form>

        <!-- Dynamické zobrazení nové celkové ceny -->
        <p>New Final Price: <span id="final_price">{{ auction.price|default:auction.start_price }}</span> Kč</p>
    {% endif %}
    
    <h2>Bids</h2>
    {% if bids %}
        <table>
            <thead>
                <tr>
                    <th>Price</th>
                    <th>Bid</th>
                    <th>Time</th>
                    <th>User</th>
                </tr>
            </thead>
            <tbody>
                {% for bid in bids %}
                <tr>
                    <td>{{ bid.price }}</td>
                    <td>{{ bid.amount }} Kč</td>
                    <td>{{ bid.timestamp|date:"d.m.Y H:i:s" }}</td>
                    <!-- Odkaz na detail uživatele, který přihodil -->
                    <td><a href="{% url 'user_detail' bid.user.id %}">{{ bid.user }}</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No bids yet.</p>
    {% endif %}
{% endif %}

<a href="javascript:history.back()" style="text-decoration: none; color: inherit;">Back to Previous Page</a>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const bidInput = document.getElementById('new_bid');
    const finalPriceDisplay = document.getElementById('final_price');

    // Získání aktuální ceny (buď auction.price, nebo auction.start_price)
    let currentPrice = parseFloat(finalPriceDisplay.textContent);

    // Pokud je currentPrice NaN, nastav currentPrice na nulu
    if (isNaN(currentPrice)) {
        currentPrice = 0;
    }

    // Aktualizace ceny při změně vstupu
    bidInput.addEventListener('input', function() {
        const bidValue = parseFloat(bidInput.value);

        // Pokud je vstup prázdný, zobrazí se původní cena (currentPrice)
        if (bidInput.value === '') {
            finalPriceDisplay.textContent = currentPrice.toFixed(2);
        } else if (!isNaN(bidValue) && bidValue >= 0) {
            const newPrice = currentPrice + bidValue;
            finalPriceDisplay.textContent = newPrice.toFixed(2);
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bidForm = document.querySelector('form');

    // Uložení přesné pozice scrollu před odesláním formuláře
    if (bidForm) {
        bidForm.addEventListener('submit', function(event) {
            // Uložit aktuální scroll pozici do localStorage
            localStorage.setItem('scrollPosition', window.scrollY);
        });
    }

    // Obnovení pozice po načtení stránky
    const scrollPosition = localStorage.getItem('scrollPosition');
    if (scrollPosition) {
        setTimeout(() => {
            window.scrollTo(0, parseInt(scrollPosition, 10));
            localStorage.removeItem('scrollPosition');  // Odstranit, aby se nepoužívala znovu
        }, 100);  // Zpoždění, aby se stránka načetla
    }

    // Pokud chcete stále sjíždět na konec po každém načtení, můžete zachovat tento kód
    window.addEventListener('load', function() {
        setTimeout(() => {
            window.scrollTo(0, document.body.scrollHeight);
        }, 100);  // Po načtení stránky sjede dolů
    });
});
</script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">

{% endblock %}